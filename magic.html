<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Создатель Магии - Все серии.</title>
    <link href="https://vjs.zencdn.net/8.23.4/video-js.css" rel="stylesheet"/>
    <link rel="stylesheet" href="static/css/anime.css">
</head>
<body>
<div class="container">
    <div class="save-indicator" id="saveIndicator">Позиция сохранена</div>

    <header>
        <h1 class="title">Создатель магии</h1>
        <p class="subtitle">Все серии</p>
    </header>

    <main>
        <section class="video-container">
            <video
                    id="my-video"
                    class="video-js vjs-default-skin"
                    controls
                    preload="auto"
                    poster=""
                    data-setup='{}'
            >
                <source src="https://vkvd388.okcdn.ru/?expires=1764588344127&srcIp=62.109.4.81&pr=40&srcAg=CHROME&ms=45.136.22.179&type=2&subId=8039248169592&sig=07hReHACoqY&ct=0&urls=185.226.53.164&clientType=13&appId=512000384397&id=8038966561400"
                        type="video/mp4"/>
                <p class="vjs-no-js">
                    Включите JavaScript и используйте браузер, поддерживающий
                    HTML5 видео
                </p>
            </video>
        </section>

        <section class="info-section">
            <h2 class="info-title">О сериале</h2>
            <p class="info-text">«Создатель магии в ином мире» — это аниме 2025
                года в жанре исекай о парне по имени Шион, который, мечтая о
                магии, умирает в 30 лет и перерождается в другом мире. Там он
                обретает возможность создавать магию с нуля, при этом другие
                жители мира ее не знают. Ему помогает сестра Мари, с которой он
                отправляется на поиски приключений.</p>
        </section>
    </main>

    <footer>
        © 2025 Смотри Аниме на AniWatch!
    </footer>
</div>

<script src="https://vjs.zencdn.net/8.23.4/video.min.js"></script>
<script>
    // Инициализация видеоплеера с правильной конфигурацией элементов времени
    const player = videojs('my-video', {
        fluid: true,
        responsive: true,
        playbackRates: [0.5, 1, 1.25, 1.5, 2],
        controlBar: {
            volumePanel: {
                inline: false
            }
        }
    });

    // Элемент для показа уведомлений
    const saveIndicator = document.getElementById('saveIndicator');

    // Функция для показа уведомления
    function showSaveIndicator() {
        saveIndicator.classList.add('show');
        setTimeout(() => {
            saveIndicator.classList.remove('show');
        }, 2000);
    }

    // Ключ для сохранения в localStorage
    const VIDEO_POSITION_KEY = 'myBratikVideoPosition';
    const SAVE_INTERVAL = 3000;

    // Загрузка сохраненной позиции
    function loadVideoPosition() {
        try {
            const savedPosition = localStorage.getItem(VIDEO_POSITION_KEY);
            if (savedPosition) {
                const position = parseFloat(savedPosition);
                console.log('Загружена позиция:', position);

                if (player.readyState() >= 1) {
                    if (position > 0 && position < player.duration()) {
                        player.currentTime(position);
                        console.log('Позиция восстановлена:', formatTime(position));
                    }
                } else {
                    player.one('loadedmetadata', function () {
                        if (position > 0 && position < player.duration()) {
                            player.currentTime(position);
                            console.log('Позиция восстановлена (после загрузки):', formatTime(position));
                        }
                    });
                }
            }
        } catch (error) {
            console.error('Ошибка при загрузке позиции:', error);
        }
    }

    // Сохранение текущей позиции
    function saveVideoPosition() {
        try {
            const currentTime = player.currentTime();
            if (currentTime && currentTime > 0) {
                localStorage.setItem(VIDEO_POSITION_KEY, currentTime.toString());
                console.log('Позиция сохранена:', formatTime(currentTime));
            }
        } catch (error) {
            console.error('Ошибка при сохранении позиции:', error);
        }
    }

    // Форматирование времени в читаемый вид
    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
    }

    // Автоматическое сохранение
    let saveInterval;

    player.ready(function () {
        console.log('Плеер готов');

        // Загружаем сохраненную позицию
        setTimeout(loadVideoPosition, 1000);

        // Запускаем интервал сохранения
        saveInterval = setInterval(saveVideoPosition, SAVE_INTERVAL);

        // Сохраняем позицию при паузе
        player.on('pause', function () {
            saveVideoPosition();
            showSaveIndicator();
        });

        // Сохраняем позицию при смене времени вручную
        player.on('seeked', function () {
            setTimeout(saveVideoPosition, 500);
        });

        // Сохраняем позицию при завершении видео
        player.on('ended', function () {
            localStorage.removeItem(VIDEO_POSITION_KEY);
            console.log('Видео завершено, позиция очищена');
        });

        // Сохраняем позицию при закрытии страницы
        window.addEventListener('beforeunload', saveVideoPosition);
        window.addEventListener('pagehide', saveVideoPosition);
    });

    // Обработчики ошибок
    player.on('error', function () {
        console.log('Ошибка загрузки видео');
    });

    player.on('loadeddata', function () {
        console.log('Видео успешно загружено');
    });

    // Очистка интервала при размонтировании
    player.on('dispose', function () {
        if (saveInterval) {
            clearInterval(saveInterval);
        }
    });

    // Дополнительная проверка для мобильных устройств
    document.addEventListener('visibilitychange', function () {
        if (document.hidden) {
            saveVideoPosition();
        }
    });
</script>
</body>
</html>